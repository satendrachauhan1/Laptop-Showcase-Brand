<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Cart</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  /* Global */
  body {
    font-family: 'Inter', sans-serif;
    background: #f5f6fa;
    margin: 0;
    padding: 0;
    color: #333;
  }
  a { text-decoration: none; }

  .cart-page { max-width: 1000px; margin: 40px auto; padding: 0 20px; }

  /* Back link */
  .back-link {
    display: inline-block;
    color: #1976d2;
    margin-bottom: 20px;
    font-weight: 500;
    transition: color 0.3s;
  }
  .back-link:hover { color: #0d47a1; }

  /* Header */
  .cart-header {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
  }

  /* User card */
  .user-card {
    display: flex;
    align-items: center;
    gap: 12px;
    background: #fff;
    padding: 12px 18px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    flex-grow: 1;
  }
  .user-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #1976d2;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    flex-shrink: 0;
  }
  .user-info { display: flex; flex-direction: column; }
  #userName { font-weight: 700; font-size: 1rem; color: #111; }
  .user-email { font-size: 0.9rem; color: #666; }

  /* Cart summary */
  .cart-summary {
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 150px;
    gap: 6px;
    font-weight: 600;
    font-size: 1rem;
  }

  /* Cart list */
  .cart-list {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.05);
  }
  .cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 10px;
    border-bottom: 1px solid #eee;
    border-radius: 8px;
    margin-bottom: 12px;
    transition: background 0.2s;
  }
  .cart-item:hover { background: #f9f9f9; }

  .cart-item-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .cart-item-icon {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    background: #e1e6f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #1976d2;
    font-size: 1.2rem;
    flex-shrink: 0;
  }
  .cart-item-details div { margin: 2px 0; }

  .cart-item-actions {
    text-align: right;
    min-width: 140px;
  }
  .cart-item-actions .remove-btn {
    background: #ff5252;
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.3s;
  }
  .cart-item-actions .remove-btn:hover { background: #e04848; }

  .empty {
    text-align: center;
    padding: 40px 0;
    font-size: 1rem;
    color: #888;
  }

  /* Action buttons */
  .cart-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }
  .btn {
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
  }
  .btn:hover { opacity: 0.9; }
  .primary-btn { background: #1976d2; color: #fff; }
  .primary-btn:hover { background: #0d47a1; }
  .clear-btn { background: #e0e0e0; color: #333; }
  .clear-btn:hover { background: #c7c7c7; }

  @media(max-width: 600px){
    .cart-item { flex-direction: column; align-items: flex-start; }
    .cart-item-actions { text-align: left; margin-top: 10px; }
    .cart-header { flex-direction: column; align-items: flex-start; gap: 12px; }
    .cart-summary { flex-direction: row; gap: 20px; font-size: 0.95rem; }
  }
</style>
</head>
<body>

<div class="cart-page">
  <a class="back-link" href="code.html">‚Üê Continue shopping</a>

  <div class="cart-header">
    <div class="user-card">
      <div class="user-avatar" id="userAvatar">üë§</div>
      <div class="user-info">
        <div id="userName">Not signed in</div>
        <div id="userEmail" class="user-email"></div>
      </div>
    </div>
    <div class="cart-summary">
      <div>Items: <span id="itemCountTop">0</span></div>
      <div>Total: <span id="totalPrice">‚Çπ0</span></div>
    </div>
  </div>

  <div class="cart-list" id="cartList">
    <div id="cartItemsContainer"></div>
    <div id="cartEmpty" class="empty" style="display:none">Your cart is empty. Add items from the showcase.</div>

    <div class="cart-actions">
      <button id="clearBtn" class="btn clear-btn">Clear Cart</button>
      <button id="orderBtn" class="btn primary-btn">Place Order</button>
    </div>
  </div>
</div>

<!-- Order modal -->
<div id="orderModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  align-items:center;
  justify-content:center;
  z-index:1000;
">
  <div style="
    background:#fff;
    padding:24px;
    border-radius:12px;
    max-width:500px;
    width:90%;
    box-shadow:0 12px 30px rgba(0,0,0,0.15);
    margin:auto;
    font-family: 'Inter', sans-serif;
  ">
    <h3 style="margin-top:0; margin-bottom:16px; font-size:1.25rem; color:#111;">Enter Delivery Details</h3>

    <div style="margin-bottom:14px;">
      <label style="font-weight:600; color:#333; display:block; margin-bottom:6px;">Address</label>
      <textarea id="orderAddress" rows="3" placeholder="Enter your full address" 
        style="
          width:100%; 
          padding:10px; 
          border-radius:8px; 
          border:1px solid #ccc; 
          font-size:0.95rem; 
          line-height:1.3;
          resize:none; 
          box-sizing:border-box;
          font-family: inherit;
          min-height:80px;
          vertical-align: middle;
          display: block;
        "></textarea>
    </div>

    <div style="margin-bottom:16px;">
      <label style="font-weight:600; color:#333; display:block; margin-bottom:6px;">Mobile</label>
      <input id="orderMobile" type="text" placeholder="10-digit mobile number" 
        style="
          width:100%; 
          padding:10px; 
          border-radius:8px; 
          border:1px solid #ccc; 
          font-size:0.95rem; 
          line-height:1.3;
          box-sizing:border-box;
          font-family: inherit;
          vertical-align: middle;
          display: block;
          height:40px;
        ">
    </div>

    <div style="display:flex; justify-content:flex-end; gap:10px; align-items:center;">
      <button id="orderCancel" style="
        padding:10px 20px; 
        border-radius:8px; 
        border:none; 
        background:#e0e0e0; 
        color:#333; 
        cursor:pointer; 
        font-weight:600;
        font-size:1rem;
        line-height:1.2;
        transition:0.2s;
        min-width:110px;
      ">Cancel</button>

      <button id="orderConfirm" style="
        padding:10px 20px; 
        border-radius:8px; 
        border:none; 
        background:#1976d2; 
        color:#fff; 
        cursor:pointer; 
        font-weight:600;
        font-size:1rem;
        line-height:1.2;
        transition:0.2s;
        min-width:140px;
      ">Confirm Order</button>
    </div>

    <div id="orderError" style="
      color:#c62828; 
      margin-top:12px; 
      font-size:0.9rem; 
      display:none;
    "></div>
  </div>
</div>


<script src="cart.js"></script>
<script>
async function renderCartPage() {
  await loadCart(); // load global cart & total

  const container = document.getElementById('cartItemsContainer');
  const empty = document.getElementById('cartEmpty');
  const totalEl = document.getElementById('totalPrice');
  const itemCountTop = document.getElementById('itemCountTop');
  const userAvatar = document.getElementById('userAvatar');
  const userName = document.getElementById('userName');
  const userEmail = document.getElementById('userEmail');

  // Show user info
  try {
    const raw = localStorage.getItem('authUser');
    if (raw) {
      const u = JSON.parse(raw);
      const initials = (u.name || u.email || 'U')[0].toUpperCase();
      userAvatar.innerText = initials;
      userName.innerText = u.name || u.email;
      userEmail.innerText = u.email || '';
    } else {
      userAvatar.innerText = 'üë§';
      userName.innerText = 'Not signed in';
      userEmail.innerText = '';
    }
  } catch (e) {
    userAvatar.innerText = 'üë§';
    userName.innerText = 'Not signed in';
    userEmail.innerText = '';
  }

  container.innerHTML = '';
  if (!cart || cart.length === 0) {
    empty.style.display = 'block';
    totalEl.innerText = '‚Çπ0';
    itemCountTop.innerText = '0';
    return;
  }
  empty.style.display = 'none';

  cart.forEach((it, idx) => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    const qty = it.quantity || 1;
    const subtotal = (Number(it.price) || 0) * qty;

    div.innerHTML = `
      <div class="cart-item-info">
        <div class="cart-item-icon">${escapeHtml((it.brand||'')[0]||'')}</div>
        <div class="cart-item-details">
          <div>${escapeHtml(it.brand)}</div>
          <div style="color:#666;font-size:0.95rem">Price: ‚Çπ${it.price}</div>
        </div>
      </div>
      <div class="cart-item-actions">
        <div>Qty: ${qty}</div>
        <div style="margin-top:4px">Subtotal: ‚Çπ${subtotal}</div>
        <div style="margin-top:8px"><button data-idx="${idx}" class="remove-btn">Remove</button></div>
      </div>
    `;
    container.appendChild(div);
  });

  totalEl.innerText = '‚Çπ' + (total || 0);
  itemCountTop.innerText = cart.reduce((s,i)=>s + (i.quantity||1),0);

  document.querySelectorAll('.remove-btn').forEach(b => b.addEventListener('click', async (e) => {
    const i = Number(e.currentTarget.dataset.idx);
    if (!Number.isFinite(i)) return;
    await removeCartItem(i);
    await renderCartPage();
  }));
}

function escapeHtml(s){ 
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); 
}

// show order modal to collect address/mobile, require login to save order
document.getElementById('orderBtn').addEventListener('click', async () => {
  const token = (typeof authToken === 'function') ? authToken() : localStorage.getItem('authToken');
  if (!token) {
    alert('Please sign in to place an order so we can save delivery details.');
    return;
  }
  document.getElementById('orderModal').style.display = 'flex';
});

document.getElementById('orderCancel').addEventListener('click', () => {
  document.getElementById('orderModal').style.display = 'none';
  document.getElementById('orderError').style.display = 'none';
});

document.getElementById('orderConfirm').addEventListener('click', async () => {
  const addr = document.getElementById('orderAddress').value.trim();
  const mobile = document.getElementById('orderMobile').value.trim();
  const errEl = document.getElementById('orderError');
  errEl.style.display = 'none';
  if (!addr) { errEl.innerText = 'Address is required.'; errEl.style.display = 'block'; return; }
  if (!/^\d{10}$/.test(mobile)) { errEl.innerText = 'Enter a valid 10 digit mobile number.'; errEl.style.display = 'block'; return; }

  const token = (typeof authToken === 'function') ? authToken() : localStorage.getItem('authToken');
  if (!token) { alert('Please sign in to place an order.'); return; }

  try {
    const res = await fetch((window.API_BASE||'http://localhost:5000') + '/api/orders', {
      method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
      body: JSON.stringify({ address: addr, mobile })
    });
    const data = await res.json();
    if (!res.ok) {
      errEl.innerText = data.message || 'Could not place order'; errEl.style.display='block'; return;
    }
    // success
    alert('Order placed successfully!');
    document.getElementById('orderModal').style.display = 'none';
    // refresh cart state
    cart = []; total = 0; saveCart(); updateCartCount();
    await renderCartPage();
    // navigate to orders page
    window.location.href = 'orders.html';
  } catch (e) {
    console.error(e);
    errEl.innerText = 'Server error while placing order.'; errEl.style.display='block';
  }
});

document.getElementById('clearBtn').addEventListener('click', async () => {
  const token = (typeof authToken === 'function') ? authToken() : localStorage.getItem('authToken');
  if (token) {
    try {
      await fetch((window.API_BASE||'http://localhost:5000') + '/api/cart/clear', { method: 'POST', headers: { Authorization: 'Bearer ' + token } });
    } catch (e) { console.error(e); }
  }
  cart = []; total = 0; saveCart(); updateCartCount(); 
  await renderCartPage();
});

renderCartPage();
</script>

</body>
</html>
